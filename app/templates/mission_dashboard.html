{% extends "base.html" %}

{% block title %}{{ mission.name }} - Painel{% endblock %}

{% block content %}
<section class="hero">
  <span class="eyebrow">Painel da missao</span>
  <h1>{{ mission.name }}</h1>
  <p class="lead">Status geral e progresso dos projetos em um so lugar.</p>
  <span class="badge">{{ mission.status }} · {{ mission.progress }}%</span>
  <a class="link" href="{{ url_for('public.mission_chat', slug=mission.slug) }}">Abrir chat</a>
</section>

<section class="details">
  <div class="detail-card">
    <h2>Resumo rapido</h2>
    <p class="muted">Progresso geral da missao</p>
    <div class="progress">
      <div class="progress-bar">
        <span style="width: {{ mission.progress }}%;"></span>
      </div>
      <span class="muted">Atualizado a partir das tarefas dos projetos.</span>
    </div>
  </div>
  <div class="detail-card">
    <h2>Reuniao da missao</h2>
    {% if mission.meeting_link %}
      <p class="muted">Link rapido para encontro da equipe.</p>
      <a class="link" href="{{ mission.meeting_link }}" target="_blank" rel="noreferrer">Abrir reuniao</a>
    {% else %}
      <p class="muted">Nenhum link de reuniao cadastrado.</p>
      <a class="link" href="{{ url_for('auth.google_meet', slug=mission.slug) }}">Criar link Meet</a>
    {% endif %}
  </div>
  <div class="detail-card">
    <h2>Financeiro</h2>
    {% if can_view_finance %}
      <p class="muted">Acompanhe entradas, saidas e prestacao de contas.</p>
      <a class="link" href="{{ url_for('public.mission_finance', slug=mission.slug) }}">Abrir financeiro</a>
    {% else %}
      <p class="muted">Somente Admin e Financeiro acessam essa area.</p>
    {% endif %}
  </div>
</section>

{% if recent_closed %}
<section>
  <h2>Projetos encerrados recentemente</h2>
  <ul class="list">
    {% for project in recent_closed %}
      <li>
        <div class="stack">
          <strong>{{ project.title }}</strong>
          <span class="muted">Encerrado em {{ project.closed_at }}</span>
        </div>
      </li>
    {% endfor %}
  </ul>
</section>
{% endif %}

<section>
  <div class="details">
    <div class="detail-card">
      <h2>Projetos da missao</h2>
      <p class="muted">Acompanhe andamento e status financeiro.</p>
    </div>
    <div class="detail-card">
      <h2>Filtro</h2>
      <label class="muted">
        <input id="toggle-closed" type="checkbox">
        Mostrar projetos encerrados
      </label>
    </div>
  </div>
  <div class="grid">
    {% if mission.projects %}
      {% for project in mission.projects %}
        {% set finance_project = None %}
        {% if finance and finance.projects %}
          {% for item in finance.projects %}
            {% if item.id == project.id %}
              {% set finance_project = item %}
            {% endif %}
          {% endfor %}
        {% endif %}
        <article class="card" style="--i: {{ loop.index0 }};" data-status="{{ project.status }}">
          <p class="meta">{{ project.status }} · {{ project.progress }}%</p>
          <h2>{{ project.title }}</h2>
          <p>{{ project.description }}</p>
          <div class="progress">
            <div class="progress-bar">
              <span style="width: {{ project.progress }}%;"></span>
            </div>
            <span class="muted">{{ project.tasks_done }}/{{ project.tasks_total }} tarefas concluidas</span>
          </div>
          {% if finance_project %}
            <span class="muted">Orcamento: R$ {{ "%.2f"|format(finance_project.budget) }}</span>
            <span class="muted">Gasto: R$ {{ "%.2f"|format(finance_project.spent) }}</span>
            <span class="muted">Restante: R$ {{ "%.2f"|format(finance_project.remaining) }}</span>
          {% endif %}
          {% if project.meeting_link %}
            <a class="link" href="{{ project.meeting_link }}" target="_blank" rel="noreferrer">Reuniao do projeto</a>
          {% else %}
            <a class="link" href="{{ url_for('auth.google_meet', slug=mission.slug, project_id=project.id) }}">Criar link Meet</a>
          {% endif %}
          <a class="link" href="{{ url_for('public.mission_project_detail', slug=mission.slug, project_id=project.id) }}">Detalhes</a>
        </article>
      {% endfor %}
    {% else %}
      <div class="empty">Nenhum projeto cadastrado.</div>
    {% endif %}
  </div>
</section>

<script>
  const toggleClosed = document.getElementById("toggle-closed");
  if (toggleClosed) {
    const applyFilter = () => {
      const showClosed = toggleClosed.checked;
      document.querySelectorAll("[data-status]").forEach((card) => {
        const status = card.getAttribute("data-status") || "";
        if (status === "concluida" && !showClosed) {
          card.style.display = "none";
        } else {
          card.style.display = "";
        }
      });
    };
    applyFilter();
    toggleClosed.addEventListener("change", () => {
      applyFilter();
    });
  }
</script>

<section>
  <h2>Equipe e contato rapido</h2>
  {% if users %}
    <ul class="list">
      {% for user in users %}
        <li>
          <div class="stack">
            <strong>{{ user.name }}</strong>
            <span class="muted">{{ user.role }}</span>
            <span class="muted">{{ user.email }}</span>
            {% if user.institutional_email %}
              <span class="muted">{{ user.institutional_email }}</span>
            {% endif %}
            <a class="link" href="{{ url_for('public.mission_chat', slug=mission.slug, with=user.email) }}">Conversar</a>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="empty">Nenhuma pessoa cadastrada.</div>
  {% endif %}
</section>
{% endblock %}
